// Generated by CoffeeScript 1.9.3
(function() {
  var $, addVariable, changeToInput, changeToSpan, createInput, newLi;

  $ = require('web/static/js/jquery-1.11.3.min');

  createInput = function(attr) {
    var input;
    if (!attr) {
      attr = {};
    }
    input = $(document.createElement('input'));
    attr.type = 'text';
    if (attr) {
      input.attr(attr);
    }
    return input;
  };

  newLi = function(attr) {
    var e, input;
    e = $(document.createElement('li'));
    if (attr) {
      e.attr(attr);
    }
    input = createInput();
    e.append(input);
    return e;
  };

  changeToSpan = function(input) {
    var j, len, ref, span, val, w;
    span = $(document.createElement('span'));
    val = input.val();
    span.addClass('task').append(val);
    ref = val.split(' ');
    for (j = 0, len = ref.length; j < len; j++) {
      w = ref[j];
      if (w[0] === ':') {
        addVariable(w);
      }
    }
    return input.closest('li').html(span);
  };

  changeToInput = function(span) {
    var input;
    input = createInput({
      value: span.text()
    });
    return span.closest('li').html(input);
  };

  addVariable = function(variable) {
    var input, li, list;
    list = $('.variables-list');
    li = $(document.createElement('li'));
    input = $(document.createElement('input'));
    input.attr({
      type: 'text',
      'data-name': variable.substr(1)
    });
    li.text(variable + " => ").append(input);
    return list.append(li);
  };

  $(document).ready(function() {
    $('.add-more').on('click', function() {
      return $(this).before(newLi());
    });
    $('.script-list').on('focusout', 'input', function() {
      if (!$(this).val()) {
        return;
      }
      return changeToSpan($(this));
    });
    $('.script-list').on('click', 'span.task', function() {
      return changeToInput($(this));
    });
    $('.script-list').on('click', '.screenshot-icon', function() {
      var img;
      img = $(document.createElement('img'));
      img.attr({
        src: $(this).data('screenshot')
      });
      return $('.screenshot_container').html(img);
    });
    return $('#run-scraper').on('click', function() {
      var data, e, j, len, ref, t, tasks, v, variables;
      tasks = (function() {
        var j, len, ref, results;
        ref = $('.script-list li');
        results = [];
        for (j = 0, len = ref.length; j < len; j++) {
          t = ref[j];
          if (t.innerText) {
            results.push(t.innerText);
          }
        }
        return results;
      })();
      variables = {};
      ref = $('.variables-list li input');
      for (j = 0, len = ref.length; j < len; j++) {
        v = ref[j];
        e = $(v);
        if (e.val()) {
          variables[e.data('name')] = e.val();
        }
      }
      data = {
        data: variables,
        script: tasks
      };
      return $.post('/api/scripts', data, function(response) {
        var i, icon, k, len1, ref1, results, screenshot_url;
        ref1 = $('.script-list span.task');
        results = [];
        for (i = k = 0, len1 = ref1.length; k < len1; i = ++k) {
          t = ref1[i];
          screenshot_url = response['debug'][i]['screenshot_url'];
          icon = $(document.createElement('span'));
          icon.addClass('screenshot-icon').attr('data-screenshot', screenshot_url);
          results.push($(t).before(icon));
        }
        return results;
      });
    });
  });

}).call(this);
